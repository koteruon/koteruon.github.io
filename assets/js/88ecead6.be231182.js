"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[4471],{72026:(e,r,s)=>{s.r(r),s.d(r,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>i,metadata:()=>l,toc:()=>d});var n=s(74848),t=s(28453);const i={},c="Resources - Metrics Server",l={id:"notes/kubernetes-basics/resources-metrics-server",title:"Resources - Metrics Server",description:"\u4ec0\u9ebc\u662f Metrics Server\uff1f",source:"@site/docs/notes/kubernetes-basics/24-resources-metrics-server.mdx",sourceDirName:"notes/kubernetes-basics",slug:"/notes/kubernetes-basics/resources-metrics-server",permalink:"/docs/notes/kubernetes-basics/resources-metrics-server",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:24,frontMatter:{},sidebar:"notesSidebar",previous:{title:"Resources - Resource Management",permalink:"/docs/notes/kubernetes-basics/resources-resource-management"},next:{title:"Outline",permalink:"/docs/notes/design-pattern"}},o={},d=[{value:"\u4ec0\u9ebc\u662f Metrics Server\uff1f",id:"\u4ec0\u9ebc\u662f-metrics-server",level:2},{value:"\u4e3b\u8981\u529f\u80fd",id:"\u4e3b\u8981\u529f\u80fd",level:2},{value:"Metrics Server \u7684\u539f\u7406",id:"metrics-server-\u7684\u539f\u7406",level:2},{value:"\u5e38\u898b\u4f7f\u7528\u5834\u666f",id:"\u5e38\u898b\u4f7f\u7528\u5834\u666f",level:2},{value:"\u9650\u5236\u8207\u6ce8\u610f\u4e8b\u9805",id:"\u9650\u5236\u8207\u6ce8\u610f\u4e8b\u9805",level:2},{value:"\u5be6\u4f5c\u4e00\u500b Metrics Server",id:"\u5be6\u4f5c\u4e00\u500b-metrics-server",level:2},{value:"\u5b89\u88dd Metrics Server",id:"\u5b89\u88dd-metrics-server",level:3},{value:"\u986f\u793a\u8cc7\u6e90\u4f7f\u7528\u8a0a\u606f",id:"\u986f\u793a\u8cc7\u6e90\u4f7f\u7528\u8a0a\u606f",level:3}];function a(e){const r={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.header,{children:(0,n.jsx)(r.h1,{id:"resources---metrics-server",children:"Resources - Metrics Server"})}),"\n",(0,n.jsx)(r.h2,{id:"\u4ec0\u9ebc\u662f-metrics-server",children:"\u4ec0\u9ebc\u662f Metrics Server\uff1f"}),"\n",(0,n.jsxs)(r.p,{children:["Metrics Server \u662f Kubernetes \u5b98\u65b9\u7684\u8f15\u91cf\u7d1a\u805a\u5408\u5668\uff0c\u7528\u65bc\u6536\u96c6\u548c\u63d0\u4f9b\u96c6\u7fa4\u4e2d\u8cc7\u6e90\u4f7f\u7528\u60c5\u6cc1\u7684\u6307\u6a19\u6578\u64da\u3002\n\u5b83\u5f9e\u5404\u500b\u7bc0\u9ede\u7684 Kubelet \u4e2d\u7372\u53d6\u8cc7\u6e90\u6578\u64da\uff08\u5982 CPU \u548c\u8a18\u61b6\u9ad4\u4f7f\u7528\u7387\uff09\uff0c\u4e26\u5c07\u9019\u4e9b\u6578\u64da\u63d0\u4f9b\u7d66 Kubernetes \u7684 ",(0,n.jsx)(r.strong,{children:"Horizontal Pod Autoscaler (HPA)"}),"\u3001",(0,n.jsx)(r.strong,{children:"Vertical Pod Autoscaler (VPA)"})," \u548c\u5176\u4ed6\u5de5\u5177\u4f7f\u7528\u3002"]}),"\n",(0,n.jsx)(r.hr,{}),"\n",(0,n.jsx)(r.h2,{id:"\u4e3b\u8981\u529f\u80fd",children:"\u4e3b\u8981\u529f\u80fd"}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.strong,{children:"\u8cc7\u6e90\u76e3\u63a7"}),"\uff1a\u6536\u96c6 Pod \u548c Node \u7684\u5373\u6642\u8cc7\u6e90\u4f7f\u7528\u6578\u64da\uff0c\u4f8b\u5982 CPU \u548c\u8a18\u61b6\u9ad4\u3002"]}),"\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.strong,{children:"\u652f\u63f4\u81ea\u52d5\u64f4\u7e2e"}),"\uff1a\u63d0\u4f9b\u6578\u64da\u7d66 HPA \u548c VPA\uff0c\u4ee5\u4fbf\u52d5\u614b\u8abf\u6574\u5de5\u4f5c\u8ca0\u8f09\u7684\u8cc7\u6e90\u5206\u914d\u3002"]}),"\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.strong,{children:"\u5373\u6642\u6578\u64da\u67e5\u8a62"}),"\uff1a\u900f\u904e ",(0,n.jsx)(r.code,{children:"kubectl top"})," \u547d\u4ee4\uff0c\u8f15\u9b06\u6aa2\u8996\u96c6\u7fa4\u7684\u5373\u6642\u8cc7\u6e90\u4f7f\u7528\u60c5\u6cc1\u3002"]}),"\n"]}),"\n",(0,n.jsx)(r.hr,{}),"\n",(0,n.jsx)(r.h2,{id:"metrics-server-\u7684\u539f\u7406",children:"Metrics Server \u7684\u539f\u7406"}),"\n",(0,n.jsxs)(r.p,{children:["Metrics Server \u662f Kubernetes \u7684\u6838\u5fc3\u7d44\u4ef6\u4e4b\u4e00\uff0c\u7528\u65bc\u5373\u6642\u6536\u96c6\u3001\u805a\u5408\u4e26\u63d0\u4f9b\u7bc0\u9ede\u8207 Pod \u7684\u8cc7\u6e90\u4f7f\u7528\u6307\u6a19\uff08\u5982 CPU \u548c\u8a18\u61b6\u9ad4\uff09\uff0c\u652f\u63f4 Kubernetes \u7684\u8cc7\u6e90\u8abf\u5ea6\u8207\u81ea\u52d5\u5316\u529f\u80fd\uff08\u5982 HPA \u548c ",(0,n.jsx)(r.code,{children:"kubectl top"}),"\uff09\u3002"]}),"\n",(0,n.jsxs)(r.ol,{children:["\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.strong,{children:"\u8cc7\u6599\u6536\u96c6"}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.strong,{children:"Kubelet"}),"\uff1aMetrics Server \u901a\u904e Kubernetes API Server \u8207\u5404\u7bc0\u9ede\u7684 Kubelet \u901a\u8a0a\uff0c\u5f9e ",(0,n.jsx)(r.code,{children:"/metrics/resource/v1alpha1"})," \u7aef\u9ede\u7372\u53d6\u5373\u6642\u7684\u7bc0\u9ede\u8207 Pod \u8cc7\u6e90\u4f7f\u7528\u6307\u6a19\u3002"]}),"\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.strong,{children:"cAdvisor"}),"\uff1aKubelet \u5167\u90e8\u6574\u5408\u4e86 cAdvisor\uff0c\u8ca0\u8cac\u5f9e\u5bb9\u5668\u5c64\u9762\u6536\u96c6 CPU\u3001\u8a18\u61b6\u9ad4\u7b49\u8cc7\u6e90\u4f7f\u7528\u6578\u64da\uff0c\u9019\u4e9b\u6578\u64da\u7d93\u7531 Kubelet \u63d0\u4f9b\u7d66 Metrics Server\u3002"]}),"\n"]}),"\n"]}),"\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.strong,{children:"\u6578\u64da\u805a\u5408"}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsx)(r.li,{children:"Metrics Server \u4ee5\u56fa\u5b9a\u7684\u6642\u9593\u9593\u9694\uff08\u9810\u8a2d 60 \u79d2\uff09\u5f9e\u6240\u6709\u7bc0\u9ede\u7684 Kubelet \u6536\u96c6\u8cc7\u6e90\u4f7f\u7528\u6578\u64da\uff0c\u4e26\u9032\u884c\u8655\u7406\u8207\u805a\u5408\uff0c\u5f62\u6210\u6574\u500b\u96c6\u7fa4\u7684\u5373\u6642\u8cc7\u6e90\u5feb\u7167\u3002"}),"\n"]}),"\n"]}),"\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.strong,{children:"\u6307\u6a19\u63d0\u4f9b"}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsxs)(r.li,{children:["Metrics Server \u5c07\u805a\u5408\u5f8c\u7684\u8cc7\u6e90\u6578\u64da\u901a\u904e ",(0,n.jsx)(r.code,{children:"/apis/metrics.k8s.io/v1beta1"})," \u7aef\u9ede\u63d0\u4f9b\u7d66 Kubernetes \u7d44\u4ef6\uff0c\u652f\u63f4\u5982 HPA \u548c ",(0,n.jsx)(r.code,{children:"kubectl top"})," \u7b49\u5de5\u5177\u67e5\u8a62\u3002"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(r.hr,{}),"\n",(0,n.jsx)(r.h2,{id:"\u5e38\u898b\u4f7f\u7528\u5834\u666f",children:"\u5e38\u898b\u4f7f\u7528\u5834\u666f"}),"\n",(0,n.jsxs)(r.ol,{children:["\n",(0,n.jsxs)(r.li,{children:["\n",(0,n.jsxs)(r.p,{children:[(0,n.jsx)(r.strong,{children:"Horizontal Pod Autoscaler (HPA)"}),"\nMetrics Server \u63d0\u4f9b Pod \u7684\u5373\u6642\u8cc7\u6e90\u4f7f\u7528\u6578\u64da\uff0c\u5e6b\u52a9 HPA \u6839\u64da\u8ca0\u8f09\u52d5\u614b\u8abf\u6574\u526f\u672c\u6578\u91cf\u3002"]}),"\n"]}),"\n",(0,n.jsxs)(r.li,{children:["\n",(0,n.jsxs)(r.p,{children:[(0,n.jsx)(r.strong,{children:"\u8cc7\u6e90\u4f7f\u7528\u76e3\u63a7"}),"\n\u904b\u7dad\u4eba\u54e1\u53ef\u4f7f\u7528 ",(0,n.jsx)(r.code,{children:"kubectl top"})," \u6307\u4ee4\u5feb\u901f\u4e86\u89e3\u96c6\u7fa4\u4e2d Pod \u548c Node \u7684\u8cc7\u6e90\u4f7f\u7528\u60c5\u6cc1\u3002"]}),"\n"]}),"\n",(0,n.jsxs)(r.li,{children:["\n",(0,n.jsxs)(r.p,{children:[(0,n.jsx)(r.strong,{children:"\u8a3a\u65b7\u8207\u6392\u67e5"}),"\nMetrics Server \u5e6b\u52a9\u8b58\u5225\u8cc7\u6e90\u74f6\u9838\uff0c\u4f8b\u5982\u67d0\u4e9b Pod \u6216 Node \u7684 CPU \u6216\u8a18\u61b6\u9ad4\u904e\u5ea6\u4f7f\u7528\u3002"]}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(r.hr,{}),"\n",(0,n.jsx)(r.h2,{id:"\u9650\u5236\u8207\u6ce8\u610f\u4e8b\u9805",children:"\u9650\u5236\u8207\u6ce8\u610f\u4e8b\u9805"}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsx)(r.li,{children:"Metrics Server \u4e0d\u5132\u5b58\u6b77\u53f2\u6578\u64da\uff0c\u50c5\u63d0\u4f9b\u5373\u6642\u7684\u8cc7\u6e90\u4f7f\u7528\u5feb\u7167\u3002"}),"\n",(0,n.jsxs)(r.li,{children:["\u9700\u8981\u78ba\u4fdd\u96c6\u7fa4\u4e2d\u7684 ",(0,n.jsx)(r.strong,{children:"Kubelet"})," \u555f\u7528\u4e86 ",(0,n.jsx)(r.code,{children:"--enable-metrics"})," \u6a19\u8a8c\uff0c\u5426\u5247\u53ef\u80fd\u7121\u6cd5\u7372\u53d6\u6578\u64da\u3002"]}),"\n",(0,n.jsx)(r.li,{children:"\u7121\u6cd5\u76f4\u63a5\u7528\u65bc\u9577\u671f\u8cc7\u6e90\u76e3\u63a7\uff08\u5efa\u8b70\u7d50\u5408 Prometheus \u7b49\u5de5\u5177\uff09\u3002"}),"\n"]}),"\n",(0,n.jsx)(r.hr,{}),"\n",(0,n.jsx)(r.h2,{id:"\u5be6\u4f5c\u4e00\u500b-metrics-server",children:"\u5be6\u4f5c\u4e00\u500b Metrics Server"}),"\n",(0,n.jsx)(r.h3,{id:"\u5b89\u88dd-metrics-server",children:"\u5b89\u88dd Metrics Server"}),"\n",(0,n.jsxs)(r.ol,{children:["\n",(0,n.jsx)(r.li,{children:"\u9996\u5148\u6211\u5011\u6211\u5148\u4e0b\u8f09\u5b98\u65b9\u7684 yaml \u8a2d\u5b9a\u6a94\uff0c\u56e0\u70ba\u5f8c\u7e8c\u9700\u8981\u505a\u4fee\u6539"}),"\n"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:'Invoke-WebRequest -Uri "https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml" -OutFile "components.yaml"\n'})}),"\n",(0,n.jsxs)(r.ol,{start:"2",children:["\n",(0,n.jsxs)(r.li,{children:["\u56e0\u70ba\u6211\u5011\u662f\u5728\u6e2c\u8a66\u74b0\u5883\uff0c\u4e0d\u9700\u8981\u8a2d\u5b9a\u6191\u8b49\uff0c\u56e0\u6b64\u5728\u5927\u6982 136 \u884c\u7684\u5730\u65b9\uff0c\u8981\u52a0\u4e0a ",(0,n.jsx)(r.code,{children:"--kubelet-insecure-tls"}),"\uff0c\u4fee\u6539\u5f8c\u5b58\u6a94\u3002"]}),"\n"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-yaml",metastring:'title="components.yaml"',children:"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    k8s-app: metrics-server\n  name: metrics-server\n  namespace: kube-system\nspec:\n  selector:\n    matchLabels:\n      k8s-app: metrics-server\n  strategy:\n    rollingUpdate:\n      maxUnavailable: 0\n  template:\n    metadata:\n      labels:\n        k8s-app: metrics-server\n    spec:\n      containers:\n        - args:\n            - --cert-dir=/tmp\n            - --secure-port=10250\n            - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname\n            - --kubelet-use-node-status-port\n            - --metric-resolution=15s\n            # \u52a0\u4e0a\u9019\u500b\u4e0b\u9762\u9019\u884c\uff0c\u56e0\u70ba\u6211\u5011\u5728\u6e2c\u8a66\u74b0\u5883\uff0c\u56e0\u6b64\u4e0d\u9700\u8981\u505aCA\u6191\u8b49\n            // highlight-next-line\n            - --kubelet-insecure-tls\n          image: registry.k8s.io/metrics-server/metrics-server:v0.7.2\n          imagePullPolicy: IfNotPresent\n"})}),"\n",(0,n.jsxs)(r.ol,{start:"3",children:["\n",(0,n.jsx)(r.li,{children:"\u63a5\u4e0b\u4f86\u5c31\u53ef\u4ee5\u900f\u904e\u6307\u4ee4\u5c07\u4ed6\u8dd1\u8d77\u4f86\u3002"}),"\n"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:"kubectl.exe apply -f components.yaml\n---\n\nserviceaccount/metrics-server created\nclusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created\nclusterrole.rbac.authorization.k8s.io/system:metrics-server created\nrolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created\nclusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created\nclusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created\nservice/metrics-server created\ndeployment.apps/metrics-server created\napiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created\n"})}),"\n",(0,n.jsxs)(r.ol,{start:"4",children:["\n",(0,n.jsx)(r.li,{children:"\u63a5\u8457\u6211\u5011\u5c31\u53ef\u4ee5\u67e5\u770b\u662f\u5426\u5efa\u7acb\u6210\u529f\uff0c\u770b\u5230 1/1 \u5c31\u4ee3\u8868\u6210\u529f\u5efa\u7acb\u4e86\u3002"}),"\n"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:'kubectl get pods -n kube-system | Select-String "metrics-server"\n---\n\nmetrics-server-598746d78d-jld2d          1/1     Running   0              29s\n'})}),"\n",(0,n.jsx)(r.h3,{id:"\u986f\u793a\u8cc7\u6e90\u4f7f\u7528\u8a0a\u606f",children:"\u986f\u793a\u8cc7\u6e90\u4f7f\u7528\u8a0a\u606f"}),"\n",(0,n.jsxs)(r.ol,{children:["\n",(0,n.jsx)(r.li,{children:"\u6211\u5011\u53ef\u4ee5\u900f\u904e\u6307\u4ee4\u67e5\u770b\u8cc7\u6e90\u4f7f\u7528\u7684\u72c0\u6cc1"}),"\n"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:"kubectl.exe top pods -n kube-system\n---\n\nNAME                                     CPU(cores)   MEMORY(bytes)\ncoredns-5d78c9869d-rpqhf                 1m           26Mi\ncoredns-5d78c9869d-sjhtn                 1m           25Mi\netcd-docker-desktop                      9m           100Mi\nkube-apiserver-docker-desktop            12m          326Mi\nkube-controller-manager-docker-desktop   7m           73Mi\nkube-proxy-8fmdr                         1m           27Mi\nkube-scheduler-docker-desktop            2m           34Mi\nmetrics-server-598746d78d-jld2d          2m           26Mi\nstorage-provisioner                      1m           22Mi\nvpnkit-controller                        1m           17Mi\n"})}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:"kubectl.exe top node\n---\n\nNAME             CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%\ndocker-desktop   178m         0%     3080Mi          19%\n"})})]})}function h(e={}){const{wrapper:r}={...(0,t.R)(),...e.components};return r?(0,n.jsx)(r,{...e,children:(0,n.jsx)(a,{...e})}):a(e)}},28453:(e,r,s)=>{s.d(r,{R:()=>c,x:()=>l});var n=s(96540);const t={},i=n.createContext(t);function c(e){const r=n.useContext(i);return n.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function l(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:c(e.components),n.createElement(i.Provider,{value:r},e.children)}}}]);