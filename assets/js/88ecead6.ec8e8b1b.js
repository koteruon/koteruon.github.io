"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[4471],{72026:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>i,default:()=>h,frontMatter:()=>t,metadata:()=>c,toc:()=>d});var s=r(74848),a=r(28453);const t={},i="Resources - Metrics Server",c={id:"notes/kubernetes-basics/resources-metrics-server",title:"Resources - Metrics Server",description:"\u4ec0\u9ebc\u662f Metrics Server\uff1f",source:"@site/docs/notes/kubernetes-basics/24-resources-metrics-server.mdx",sourceDirName:"notes/kubernetes-basics",slug:"/notes/kubernetes-basics/resources-metrics-server",permalink:"/docs/notes/kubernetes-basics/resources-metrics-server",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:24,frontMatter:{},sidebar:"notesSidebar",previous:{title:"Resources - Resource Management",permalink:"/docs/notes/kubernetes-basics/resources-resource-management"},next:{title:"Outline",permalink:"/docs/notes/design-pattern"}},o={},d=[{value:"\u4ec0\u9ebc\u662f Metrics Server\uff1f",id:"\u4ec0\u9ebc\u662f-metrics-server",level:2},{value:"\u4e3b\u8981\u529f\u80fd",id:"\u4e3b\u8981\u529f\u80fd",level:2},{value:"Metrics Server \u7684\u539f\u7406",id:"metrics-server-\u7684\u539f\u7406",level:2},{value:"\u5e38\u898b\u4f7f\u7528\u5834\u666f",id:"\u5e38\u898b\u4f7f\u7528\u5834\u666f",level:2},{value:"\u9650\u5236\u8207\u6ce8\u610f\u4e8b\u9805",id:"\u9650\u5236\u8207\u6ce8\u610f\u4e8b\u9805",level:2},{value:"\u5be6\u4f5c\u4e00\u500b Metrics Server",id:"\u5be6\u4f5c\u4e00\u500b-metrics-server",level:2},{value:"\u5b89\u88dd Metrics Server",id:"\u5b89\u88dd-metrics-server",level:3},{value:"\u986f\u793a\u8cc7\u6e90\u4f7f\u7528\u8a0a\u606f",id:"\u986f\u793a\u8cc7\u6e90\u4f7f\u7528\u8a0a\u606f",level:3},{value:"\u6253\u9020\u8cc7\u6e90\u76e3\u63a7\u7cfb\u7d71",id:"\u6253\u9020\u8cc7\u6e90\u76e3\u63a7\u7cfb\u7d71",level:2},{value:"cAdvisor",id:"cadvisor",level:3},{value:"Prometheus + Grafana",id:"prometheus--grafana",level:3},{value:"\u8a2d\u5b9a Grafana \u7684 Data Source",id:"\u8a2d\u5b9a-grafana-\u7684-data-source",level:3},{value:"\u8a2d\u5b9a Grafana \u6a21\u677f",id:"\u8a2d\u5b9a-grafana-\u6a21\u677f",level:3},{value:"\u8996\u89ba\u5316\u76e3\u63a7\u7cfb\u7d71\u5c55\u793a",id:"\u8996\u89ba\u5316\u76e3\u63a7\u7cfb\u7d71\u5c55\u793a",level:3}];function l(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"resources---metrics-server",children:"Resources - Metrics Server"})}),"\n",(0,s.jsx)(n.h2,{id:"\u4ec0\u9ebc\u662f-metrics-server",children:"\u4ec0\u9ebc\u662f Metrics Server\uff1f"}),"\n",(0,s.jsxs)(n.p,{children:["Metrics Server \u662f Kubernetes \u5b98\u65b9\u7684\u8f15\u91cf\u7d1a\u805a\u5408\u5668\uff0c\u7528\u65bc\u6536\u96c6\u548c\u63d0\u4f9b\u96c6\u7fa4\u4e2d\u8cc7\u6e90\u4f7f\u7528\u60c5\u6cc1\u7684\u6307\u6a19\u6578\u64da\u3002\n\u5b83\u5f9e\u5404\u500b\u7bc0\u9ede\u7684 Kubelet \u4e2d\u7372\u53d6\u8cc7\u6e90\u6578\u64da\uff08\u5982 CPU \u548c\u8a18\u61b6\u9ad4\u4f7f\u7528\u7387\uff09\uff0c\u4e26\u5c07\u9019\u4e9b\u6578\u64da\u63d0\u4f9b\u7d66 Kubernetes \u7684 ",(0,s.jsx)(n.strong,{children:"Horizontal Pod Autoscaler (HPA)"}),"\u3001",(0,s.jsx)(n.strong,{children:"Vertical Pod Autoscaler (VPA)"})," \u548c\u5176\u4ed6\u5de5\u5177\u4f7f\u7528\u3002"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"\u4e3b\u8981\u529f\u80fd",children:"\u4e3b\u8981\u529f\u80fd"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"\u8cc7\u6e90\u76e3\u63a7"}),"\uff1a\u6536\u96c6 Pod \u548c Node \u7684\u5373\u6642\u8cc7\u6e90\u4f7f\u7528\u6578\u64da\uff0c\u4f8b\u5982 CPU \u548c\u8a18\u61b6\u9ad4\u3002"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"\u652f\u63f4\u81ea\u52d5\u64f4\u7e2e"}),"\uff1a\u63d0\u4f9b\u6578\u64da\u7d66 HPA \u548c VPA\uff0c\u4ee5\u4fbf\u52d5\u614b\u8abf\u6574\u5de5\u4f5c\u8ca0\u8f09\u7684\u8cc7\u6e90\u5206\u914d\u3002"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"\u5373\u6642\u6578\u64da\u67e5\u8a62"}),"\uff1a\u900f\u904e ",(0,s.jsx)(n.code,{children:"kubectl top"})," \u547d\u4ee4\uff0c\u8f15\u9b06\u6aa2\u8996\u96c6\u7fa4\u7684\u5373\u6642\u8cc7\u6e90\u4f7f\u7528\u60c5\u6cc1\u3002"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"metrics-server-\u7684\u539f\u7406",children:"Metrics Server \u7684\u539f\u7406"}),"\n",(0,s.jsxs)(n.p,{children:["Metrics Server \u662f Kubernetes \u7684\u6838\u5fc3\u7d44\u4ef6\u4e4b\u4e00\uff0c\u7528\u65bc\u5373\u6642\u6536\u96c6\u3001\u805a\u5408\u4e26\u63d0\u4f9b\u7bc0\u9ede\u8207 Pod \u7684\u8cc7\u6e90\u4f7f\u7528\u6307\u6a19\uff08\u5982 CPU \u548c\u8a18\u61b6\u9ad4\uff09\uff0c\u652f\u63f4 Kubernetes \u7684\u8cc7\u6e90\u8abf\u5ea6\u8207\u81ea\u52d5\u5316\u529f\u80fd\uff08\u5982 HPA \u548c ",(0,s.jsx)(n.code,{children:"kubectl top"}),"\uff09\u3002"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"\u8cc7\u6599\u6536\u96c6"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Kubelet"}),"\uff1aMetrics Server \u901a\u904e Kubernetes API Server \u8207\u5404\u7bc0\u9ede\u7684 Kubelet \u901a\u8a0a\uff0c\u5f9e ",(0,s.jsx)(n.code,{children:"/metrics/resource/v1alpha1"})," \u7aef\u9ede\u7372\u53d6\u5373\u6642\u7684\u7bc0\u9ede\u8207 Pod \u8cc7\u6e90\u4f7f\u7528\u6307\u6a19\u3002"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"cAdvisor"}),"\uff1aKubelet \u5167\u90e8\u6574\u5408\u4e86 cAdvisor\uff0c\u8ca0\u8cac\u5f9e\u5bb9\u5668\u5c64\u9762\u6536\u96c6 CPU\u3001\u8a18\u61b6\u9ad4\u7b49\u8cc7\u6e90\u4f7f\u7528\u6578\u64da\uff0c\u9019\u4e9b\u6578\u64da\u7d93\u7531 Kubelet \u63d0\u4f9b\u7d66 Metrics Server\u3002"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"\u6578\u64da\u805a\u5408"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Metrics Server \u4ee5\u56fa\u5b9a\u7684\u6642\u9593\u9593\u9694\uff08\u9810\u8a2d 60 \u79d2\uff09\u5f9e\u6240\u6709\u7bc0\u9ede\u7684 Kubelet \u6536\u96c6\u8cc7\u6e90\u4f7f\u7528\u6578\u64da\uff0c\u4e26\u9032\u884c\u8655\u7406\u8207\u805a\u5408\uff0c\u5f62\u6210\u6574\u500b\u96c6\u7fa4\u7684\u5373\u6642\u8cc7\u6e90\u5feb\u7167\u3002"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"\u6307\u6a19\u63d0\u4f9b"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Metrics Server \u5c07\u805a\u5408\u5f8c\u7684\u8cc7\u6e90\u6578\u64da\u901a\u904e ",(0,s.jsx)(n.code,{children:"/apis/metrics.k8s.io/v1beta1"})," \u7aef\u9ede\u63d0\u4f9b\u7d66 Kubernetes \u7d44\u4ef6\uff0c\u652f\u63f4\u5982 HPA \u548c ",(0,s.jsx)(n.code,{children:"kubectl top"})," \u7b49\u5de5\u5177\u67e5\u8a62\u3002"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"\u5e38\u898b\u4f7f\u7528\u5834\u666f",children:"\u5e38\u898b\u4f7f\u7528\u5834\u666f"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Horizontal Pod Autoscaler (HPA)"}),"\nMetrics Server \u63d0\u4f9b Pod \u7684\u5373\u6642\u8cc7\u6e90\u4f7f\u7528\u6578\u64da\uff0c\u5e6b\u52a9 HPA \u6839\u64da\u8ca0\u8f09\u52d5\u614b\u8abf\u6574\u526f\u672c\u6578\u91cf\u3002"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"\u8cc7\u6e90\u4f7f\u7528\u76e3\u63a7"}),"\n\u904b\u7dad\u4eba\u54e1\u53ef\u4f7f\u7528 ",(0,s.jsx)(n.code,{children:"kubectl top"})," \u6307\u4ee4\u5feb\u901f\u4e86\u89e3\u96c6\u7fa4\u4e2d Pod \u548c Node \u7684\u8cc7\u6e90\u4f7f\u7528\u60c5\u6cc1\u3002"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"\u8a3a\u65b7\u8207\u6392\u67e5"}),"\nMetrics Server \u5e6b\u52a9\u8b58\u5225\u8cc7\u6e90\u74f6\u9838\uff0c\u4f8b\u5982\u67d0\u4e9b Pod \u6216 Node \u7684 CPU \u6216\u8a18\u61b6\u9ad4\u904e\u5ea6\u4f7f\u7528\u3002"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"\u9650\u5236\u8207\u6ce8\u610f\u4e8b\u9805",children:"\u9650\u5236\u8207\u6ce8\u610f\u4e8b\u9805"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Metrics Server \u4e0d\u5132\u5b58\u6b77\u53f2\u6578\u64da\uff0c\u50c5\u63d0\u4f9b\u5373\u6642\u7684\u8cc7\u6e90\u4f7f\u7528\u5feb\u7167\u3002"}),"\n",(0,s.jsxs)(n.li,{children:["\u9700\u8981\u78ba\u4fdd\u96c6\u7fa4\u4e2d\u7684 ",(0,s.jsx)(n.strong,{children:"Kubelet"})," \u555f\u7528\u4e86 ",(0,s.jsx)(n.code,{children:"--enable-metrics"})," \u6a19\u8a8c\uff0c\u5426\u5247\u53ef\u80fd\u7121\u6cd5\u7372\u53d6\u6578\u64da\u3002"]}),"\n",(0,s.jsx)(n.li,{children:"\u7121\u6cd5\u76f4\u63a5\u7528\u65bc\u9577\u671f\u8cc7\u6e90\u76e3\u63a7\uff08\u5efa\u8b70\u7d50\u5408 Prometheus \u7b49\u5de5\u5177\uff09\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"\u5be6\u4f5c\u4e00\u500b-metrics-server",children:"\u5be6\u4f5c\u4e00\u500b Metrics Server"}),"\n",(0,s.jsx)(n.h3,{id:"\u5b89\u88dd-metrics-server",children:"\u5b89\u88dd Metrics Server"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"\u9996\u5148\u6211\u5011\u6211\u5148\u4e0b\u8f09\u5b98\u65b9\u7684 yaml \u8a2d\u5b9a\u6a94\uff0c\u56e0\u70ba\u5f8c\u7e8c\u9700\u8981\u505a\u4fee\u6539"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'Invoke-WebRequest -Uri "https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml" -OutFile "components.yaml"\n'})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsxs)(n.li,{children:["\u56e0\u70ba\u6211\u5011\u662f\u5728\u6e2c\u8a66\u74b0\u5883\uff0c\u4e0d\u9700\u8981\u8a2d\u5b9a\u6191\u8b49\uff0c\u56e0\u6b64\u5728\u5927\u6982 136 \u884c\u7684\u5730\u65b9\uff0c\u8981\u52a0\u4e0a ",(0,s.jsx)(n.code,{children:"--kubelet-insecure-tls"}),"\uff0c\u4fee\u6539\u5f8c\u5b58\u6a94\u3002"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'title="components.yaml"',children:"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    k8s-app: metrics-server\n  name: metrics-server\n  namespace: kube-system\nspec:\n  selector:\n    matchLabels:\n      k8s-app: metrics-server\n  strategy:\n    rollingUpdate:\n      maxUnavailable: 0\n  template:\n    metadata:\n      labels:\n        k8s-app: metrics-server\n    spec:\n      containers:\n        - args:\n            - --cert-dir=/tmp\n            - --secure-port=10250\n            - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname\n            - --kubelet-use-node-status-port\n            - --metric-resolution=15s\n            # \u52a0\u4e0a\u9019\u500b\u4e0b\u9762\u9019\u884c\uff0c\u56e0\u70ba\u6211\u5011\u5728\u6e2c\u8a66\u74b0\u5883\uff0c\u56e0\u6b64\u4e0d\u9700\u8981\u505aCA\u6191\u8b49\n            // highlight-next-line\n            - --kubelet-insecure-tls\n          image: registry.k8s.io/metrics-server/metrics-server:v0.7.2\n          imagePullPolicy: IfNotPresent\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"3",children:["\n",(0,s.jsx)(n.li,{children:"\u63a5\u4e0b\u4f86\u5c31\u53ef\u4ee5\u900f\u904e\u6307\u4ee4\u5c07\u4ed6\u8dd1\u8d77\u4f86\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"kubectl.exe apply -f components.yaml\n---\n\nserviceaccount/metrics-server created\nclusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created\nclusterrole.rbac.authorization.k8s.io/system:metrics-server created\nrolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created\nclusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created\nclusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created\nservice/metrics-server created\ndeployment.apps/metrics-server created\napiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"4",children:["\n",(0,s.jsx)(n.li,{children:"\u63a5\u8457\u6211\u5011\u5c31\u53ef\u4ee5\u67e5\u770b\u662f\u5426\u5efa\u7acb\u6210\u529f\uff0c\u770b\u5230 1/1 \u5c31\u4ee3\u8868\u6210\u529f\u5efa\u7acb\u4e86\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'kubectl get pods -n kube-system | Select-String "metrics-server"\n---\n\nmetrics-server-598746d78d-jld2d          1/1     Running   0              29s\n'})}),"\n",(0,s.jsx)(n.h3,{id:"\u986f\u793a\u8cc7\u6e90\u4f7f\u7528\u8a0a\u606f",children:"\u986f\u793a\u8cc7\u6e90\u4f7f\u7528\u8a0a\u606f"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"\u6211\u5011\u53ef\u4ee5\u900f\u904e\u6307\u4ee4\u67e5\u770b\u8cc7\u6e90\u4f7f\u7528\u7684\u72c0\u6cc1"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"kubectl.exe top pods -n kube-system\n---\n\nNAME                                     CPU(cores)   MEMORY(bytes)\ncoredns-5d78c9869d-rpqhf                 1m           26Mi\ncoredns-5d78c9869d-sjhtn                 1m           25Mi\netcd-docker-desktop                      9m           100Mi\nkube-apiserver-docker-desktop            12m          326Mi\nkube-controller-manager-docker-desktop   7m           73Mi\nkube-proxy-8fmdr                         1m           27Mi\nkube-scheduler-docker-desktop            2m           34Mi\nmetrics-server-598746d78d-jld2d          2m           26Mi\nstorage-provisioner                      1m           22Mi\nvpnkit-controller                        1m           17Mi\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"kubectl.exe top node\n---\n\nNAME             CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%\ndocker-desktop   178m         0%     3080Mi          19%\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"\u6253\u9020\u8cc7\u6e90\u76e3\u63a7\u7cfb\u7d71",children:"\u6253\u9020\u8cc7\u6e90\u76e3\u63a7\u7cfb\u7d71"}),"\n",(0,s.jsxs)(n.p,{children:["\u63a5\u8457\u6211\u5011\u53ef\u4ee5\u900f\u904e ",(0,s.jsx)(n.strong,{children:"cAdvisor\uff08Container Advisor\uff09"})," \u7d50\u5408 ",(0,s.jsx)(n.strong,{children:"Prometheus"})," \u548c ",(0,s.jsx)(n.strong,{children:"Grafana"}),"\uff0c\u5be6\u73fe\u5c0d Docker \u5bb9\u5668\u7684 CPU\u3001\u8a18\u61b6\u9ad4\u3001\u78c1\u789f\u53ca\u7db2\u8def\u7b49\u8cc7\u6e90\u7684\u5168\u9762\u76e3\u63a7\u3002"]}),"\n",(0,s.jsx)(n.h3,{id:"cadvisor",children:"cAdvisor"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"cAdvisor"}),"\uff08Container Advisor\uff09\u662f\u4e00\u500b\u958b\u6e90\u5de5\u5177\uff0c\u7528\u65bc\u5be6\u6642\u76e3\u63a7\u5bb9\u5668\u7684\u8cc7\u6e90\u4f7f\u7528\u60c5\u6cc1\uff0c\u5982 CPU\u3001\u8a18\u61b6\u9ad4\u3001\u78c1\u789f\u548c\u7db2\u8def\u3002\u5b83\u7531 Google \u958b\u767c\uff0c\u8207 Kubernetes \u6df1\u5ea6\u6574\u5408\uff0c\u80fd\u5920\u6536\u96c6\u5bb9\u5668\u7684\u6027\u80fd\u6307\u6a19\u4e26\u63d0\u4f9b\u53ef\u8996\u5316\u7684\u76e3\u63a7\u6578\u64da\u3002"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"\u9996\u5148\u6211\u5011\u6e2c\u8a66 docker \u662f\u5426\u53ef\u4ee5\u4f7f\u7528\uff0c\u6b63\u78ba\u7684\u8a71\u6703\u986f\u793a\u51fa\u7248\u672c\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"docker --version\n---\n\nDocker version 24.0.6, build ed223bc\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsx)(n.li,{children:"\u63a5\u8457\u6211\u5011\u9700\u8981\u628a cAdvisor \u7684 image pull \u4e0b\u4f86\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"docker pull google/cadvisor\n---\n\nUsing default tag: latest\nlatest: Pulling from google/cadvisor\nDigest: sha256:815386ebbe9a3490f38785ab11bda34ec8dacf4634af77b8912832d4f85dca04\nStatus: Image is up to date for google/cadvisor:latest\ndocker.io/google/cadvisor:latest\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"3",children:["\n",(0,s.jsx)(n.li,{children:"\u63a5\u8457\u6211\u5011\u8a66\u8457\u628a cadvisor \u8dd1\u8d77\u4f86\uff0c\u900f\u904e docker \u6307\u4ee4\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-powershell",children:"docker run `\n    --volume=/:/rootfs:ro `\n    --volume=/var/run:/var/run:rw `\n    --volume=/sys:/sys:ro `\n    --volume=/var/lib/docker:/var/lib/docker:ro `\n    --publish=8884:8080 `\n    --detach=true `\n    --name=cadvisor `\n    google/cadvisor:latest\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"4",children:["\n",(0,s.jsxs)(n.li,{children:["\u900f\u904e\u7db2\u7ad9",(0,s.jsx)(n.a,{href:"http://localhost:8884/containers/",children:"http://localhost:8884/containers/"}),"\uff0c\u5982\u679c\u53ef\u4ee5\u67e5\u770b\u76ee\u524d\u7684\u6240\u6709\u96fb\u8166\u72c0\u614b\uff0c\u5c31\u4ee3\u8868\u6211\u5011\u6210\u529f\u4e86\u3002"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"cAdvisor",src:r(10662).A+"",width:"1920",height:"869"})}),"\n",(0,s.jsxs)(n.ol,{start:"5",children:["\n",(0,s.jsx)(n.li,{children:"\u63a5\u8457\u6211\u5011\u5c07\u4ed6\u95dc\u9589\uff0c\u5f8c\u7e8c\u6211\u5011\u6703\u7528 docker-compose \u4e00\u8d77\u628a\u4ed6\u8dd1\u8d77\u4f86\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"docker rm -f cadvisor\n---\n\ncadvisor\n"})}),"\n",(0,s.jsx)(n.h3,{id:"prometheus--grafana",children:"Prometheus + Grafana"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Prometheus"})," \u662f\u4e00\u500b\u958b\u6e90\u7684\u76e3\u63a7\u7cfb\u7d71\u548c\u6642\u5e8f\u6578\u64da\u5eab\uff0c\u5c08\u6ce8\u65bc\u6536\u96c6\u548c\u5b58\u5132\u6307\u6a19\u6578\u64da\uff0c\u4e26\u63d0\u4f9b\u5f37\u5927\u7684\u67e5\u8a62\u8a9e\u8a00\uff08PromQL\uff09\u9032\u884c\u6578\u64da\u5206\u6790\u3002\u5b83\u652f\u63f4\u591a\u7a2e\u6578\u64da\u6293\u53d6\u65b9\u5f0f\uff0c\u8207\u5bb9\u5668\u5316\u74b0\u5883\uff08\u5982 Kubernetes\uff09\u9ad8\u5ea6\u517c\u5bb9\uff0c\u5e38\u7528\u65bc\u7cfb\u7d71\u548c\u61c9\u7528\u6027\u80fd\u76e3\u63a7\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Grafana"})," \u662f\u4e00\u6b3e\u958b\u6e90\u7684\u6578\u64da\u53ef\u8996\u5316\u548c\u76e3\u63a7\u5de5\u5177\uff0c\u5ee3\u6cdb\u61c9\u7528\u65bc\u5206\u6790\u548c\u5c55\u793a\u4f86\u81ea\u5404\u7a2e\u6578\u64da\u6e90\uff08\u5982 Prometheus\u3001Elasticsearch\u3001InfluxDB \u7b49\uff09\u7684\u6642\u9593\u5e8f\u5217\u6578\u64da\u3002\u5b83\u63d0\u4f9b\u76f4\u89c0\u7684\u5100\u8868\u677f\u548c\u5f37\u5927\u7684\u5716\u8868\u529f\u80fd\uff0c\u4f7f\u7528\u8005\u53ef\u4ee5\u8f15\u9b06\u5275\u5efa\u52d5\u614b\u5100\u8868\u677f\u4f86\u76e3\u63a7\u7cfb\u7d71\u6027\u80fd\u3001\u61c9\u7528\u72c0\u614b\u4ee5\u53ca\u696d\u52d9\u6307\u6a19\u3002Grafana \u652f\u63f4\u5373\u6642\u6578\u64da\u66f4\u65b0\uff0c\u4e26\u63d0\u4f9b\u8c50\u5bcc\u7684\u63d2\u4ef6\u64f4\u5c55\u9078\u9805\uff0c\u8b93\u4f7f\u7528\u8005\u6839\u64da\u9700\u6c42\u5b9a\u5236\u76e3\u63a7\u754c\u9762\u3002"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"\u6aa2\u67e5 docker-compose \u6307\u4ee4\uff0c\u51fa\u73fe\u7248\u672c\u4ee3\u8868\u6b63\u5e38\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"docker-compose --version\n----\n\nDocker Compose version v2.21.0-desktop.1\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsx)(n.li,{children:"\u63a5\u8457\u6211\u5011\u64b0\u5beb\u6240\u6709\u9700\u8981\u7684 container\uff0c\u5305\u542b\u76e3\u63a7\u7cfb\u7d71\u6578\u64da\u5eab prometheus\u3001\u53ef\u8996\u5316\u76e3\u63a7\u5de5\u5177 grafana\u3001\u5be6\u6642\u76e3\u63a7\u5bb9\u5668\u7684\u8cc7\u6e90 cadvisor\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'title="deployment-with-cadvisor.yaml"',children:"version: '3.8'\nservices:\n  prometheus:\n    image: prom/prometheus:v2.35.0\n    container_name: prometheus\n    volumes:\n      - ./prometheus-with-cadvisor.yaml:/etc/prometheus/prometheus.yaml\n      - ./prometheus_data:/prometheus\n    command:\n      - '--config.file=/etc/prometheus/prometheus.yaml'\n    ports:\n      - '9090:9090'\n\n  node-exporter:\n    image: quay.io/prometheus/node-exporter\n    container_name: node-exporter\n    ports:\n      - '9100:9100'\n\n  renderer:\n    image: grafana/grafana-image-renderer\n    environment:\n      BROWSER_TZ: Asia/Taipei\n    ports:\n      - '8082:8081'\n\n  grafana:\n    image: grafana/grafana\n    container_name: grafana\n    volumes:\n      - ./grafana_data:/var/lib/grafana\n    environment:\n      GF_SECURITY_ADMIN_PASSWORD: pass\n      GF_RENDERING_SERVER_URL: http://renderer:8082/render\n      GF_RENDERING_CALLBACK_URL: http://grafana:3007/\n      GF_LOG_FILTERS: rendering:debug\n    depends_on:\n      - prometheus\n      - renderer\n    ports:\n      - '3007:3000'\n\n  cadvisor:\n    image: gcr.io/cadvisor/cadvisor:latest\n    container_name: cadvisor\n    ports:\n      - '8884:8080' # cAdvisor \u9810\u8a2d\u57e0\u865f\n    volumes:\n      - /:/rootfs:ro\n      - /var/run:/var/run:rw\n      - /sys:/sys:ro\n      - /var/lib/docker/:/var/lib/docker:ro\n    restart: unless-stopped\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"3",children:["\n",(0,s.jsx)(n.li,{children:"\u53e6\u5916\u6211\u5011\u9084\u9700\u8981\u64b0\u5beb\u4e00\u500b\u8a2d\u5b9a\u6a94\uff0c\u544a\u8a34 prometheus \u6709\u54ea\u4e9b job \u8981\u505a\uff0c\u53e6\u5916\u4e5f\u9700\u8981\u544a\u8a34\u4ed6 cAdvisor \u548c node-exporter \u7684\u8cc7\u8a0a\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'title="prometheus-with-cadvisor.yaml"',children:"global:\n  scrape_interval: 5s # Server \u6293\u53d6\u983b\u7387\n  external_labels:\n    monitor: 'my-monitor'\n\nscrape_configs:\n  - job_name: 'prometheus'\n    static_configs:\n      - targets: ['localhost:9090']\n\n  - job_name: 'node-exporter'\n    static_configs:\n      - targets: ['node-exporter:9100']\n        labels:\n          instance: 'server' # node-exporter \u548c cadvisor \u5fc5\u9808\u76f8\u540c\n\n  - job_name: 'cadvisor'\n    static_configs:\n      - targets: ['cadvisor:8080'] # cAdvisor \u7684\u670d\u52d9\u4f4d\u5740\u548c\u57e0\u865f\n        labels:\n          instance: 'server' # node-exporter \u548c cadvisor \u5fc5\u9808\u76f8\u540c\n"})}),"\n",(0,s.jsx)(n.admonition,{type:"tip",children:(0,s.jsx)(n.p,{children:"node-exporter \u548c cadvisor \u7684 labels.instance \u540d\u7a31\u5fc5\u9808\u76f8\u540c"})}),"\n",(0,s.jsxs)(n.ol,{start:"4",children:["\n",(0,s.jsx)(n.li,{children:"\u900f\u904e docker-compose \u7684\u6307\u4ee4\uff0c\u6211\u5011\u5c31\u80fd\u5c07\u6240\u6709\u7684 container \u8dd1\u8d77\u4f86\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"docker-compose -f ./deployment-with-cadvisor.yaml up -d\n---\n\n[+] Running 6/6\n \u2714 Network ch24_default       Created                                                                                 0.0s\n \u2714 Container node-exporter    Started                                                                                 0.0s\n \u2714 Container ch24-renderer-1  Started                                                                                 0.0s\n \u2714 Container prometheus       Started                                                                                 0.1s\n \u2714 Container cadvisor         Started                                                                                 0.0s\n \u2714 Container grafana          Started                                                                                 0.0s\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"5",children:["\n",(0,s.jsxs)(n.li,{children:["\u63a5\u8457\u6211\u5011\u9032\u5230 prometheus \u7684 GUI \u4ecb\u9762",(0,s.jsx)(n.a,{href:"http://localhost:9090/targets",children:"http://localhost:9090/targets"}),"\uff0c\u67e5\u770b\u4e00\u4e0b\u662f\u5426\u6709\u6293\u5230 cAdvisor \u7684\u6578\u64da\u3001\u4e26\u4e14\u9084\u6709 node-exporter \u7684\u6578\u64da\u3002"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"prometheus-target-job",src:r(31047).A+"",width:"1920",height:"869"})}),"\n",(0,s.jsx)(n.h3,{id:"\u8a2d\u5b9a-grafana-\u7684-data-source",children:"\u8a2d\u5b9a Grafana \u7684 Data Source"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"\u63a5\u8457\u6211\u5011\u9700\u8981\u5c07 prometheus \u7684\u6578\u64da\u50b3\u7d66 grafana \u505a\u986f\u793a\uff0c\u56e0\u6b64\u6211\u5011\u9996\u5148\u9700\u8981\u9078\u64c7\u5230 data source \u7684\u9801\u9762\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"grafana-datasource-sidebar",src:r(13638).A+"",width:"1920",height:"745"})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsx)(n.li,{children:"\u63a5\u4e0b\u4f86\u6211\u5011\u65b0\u589e\u4e00\u500b prometheus \u7684 datasource\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"grafana-datasource-add",src:r(96223).A+"",width:"1920",height:"518"})}),"\n",(0,s.jsxs)(n.ol,{start:"3",children:["\n",(0,s.jsxs)(n.li,{children:["\u5728\u7db2\u5740\u7684\u5730\u65b9\u6211\u5011\u586b\u5beb",(0,s.jsx)(n.code,{children:"http://prometheus:9090/"}),"\u3002"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"grafana-datasource-connect",src:r(28856).A+"",width:"1920",height:"311"})}),"\n",(0,s.jsxs)(n.ol,{start:"4",children:["\n",(0,s.jsx)(n.li,{children:"\u63a5\u8457\u6211\u5011\u5b58\u6a94\u4e26\u6e2c\u8a66\uff0c\u51fa\u73fe\u7da0\u8272\u7684\u6846\u6846\u5c31\u4ee3\u8868\u6e2c\u8a66 OK \u56c9\uff0c\u5c31\u53ef\u4ee5\u4e0b\u4e00\u6b65\u5275\u7acb dashboard\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"grafana-datasource-save",src:r(36923).A+"",width:"1920",height:"328"})}),"\n",(0,s.jsx)(n.h3,{id:"\u8a2d\u5b9a-grafana-\u6a21\u677f",children:"\u8a2d\u5b9a Grafana \u6a21\u677f"}),"\n",(0,s.jsx)(n.p,{children:"Grafana \u63d0\u4f9b\u4e86\u5f37\u5927\u7684\u6578\u64da\u53ef\u8996\u5316\u529f\u80fd\uff0c\u6211\u5011\u53ef\u4ee5\u5f9e\u7db2\u8def\u4e0a\u4e0b\u8f09\u4e26\u4f7f\u7528\u9069\u5408\u7684\u5100\u8868\u677f\u6a21\u677f\u3002"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\u56e0\u70ba\u6211\u5011\u8981\u7d50\u5408 cAdvisor\uff0c\u56e0\u6b64\u6211\u5011\u4f7f\u7528 ",(0,s.jsx)(n.a,{href:"https://grafana.com/grafana/dashboards/16314-docker-container-os-node-node-exporter-cadvisor/",children:"docker container & OS node(node_exporter, cadvisor)"})," \u9019\u500b\u6a21\u677f\uff0c\u9032\u5230\u7db2\u7ad9\u5f8c\u9ede\u9078\u4e0b\u8f09 json\u3002"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"grafana-dashboard-template",src:r(30721).A+"",width:"769",height:"685"})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsxs)(n.li,{children:["\u6211\u5011\u53ef\u4ee5\u9032\u5230\u7db2\u7ad9",(0,s.jsx)(n.a,{href:"http://localhost:3007/login",children:"http://localhost:3007/login"}),"\uff0c\u56e0\u70ba\u6211\u5011\u662f\u505a\u5be6\u9a57\uff0c\u56e0\u6b64 grafana \u7684\u5e33\u865f\u9810\u8a2d\u70ba admin\uff0c\u5bc6\u78bc\u5247\u662f pass\uff0c\u8981\u4fee\u6539\u53ef\u4ee5\u5728\u4e0a\u9762 docker-compose \u5b9a\u7fa9\u7684 yaml \u4e2d\u4fee\u6539\u3002"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"grafana-login",src:r(40015).A+"",width:"1920",height:"869"})}),"\n",(0,s.jsxs)(n.ol,{start:"3",children:["\n",(0,s.jsx)(n.li,{children:"\u63a5\u8457\u9078\u5230 dashboard \u7684\u5206\u9801\uff0c\u4e26\u4e14\u65b0\u589e\u9078\u64c7 import\uff0c\u5c07\u525b\u525b\u7684 json \u6a94\u62d6\u62c9\u5230 upload \u7684\u5730\u65b9\u5373\u53ef\uff0c\u4e26\u4e14 datasource \u9078\u64c7\u525b\u525b\u5efa\u7acb\u7684 prometheus\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"grafana-dashboard-sidebar",src:r(78003).A+"",width:"1920",height:"869"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"grafana-dashboard-import",src:r(3640).A+"",width:"1920",height:"869"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"grafana-dashboard-upload",src:r(47484).A+"",width:"902",height:"869"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"grafana-dashboard-prometheus",src:r(33559).A+"",width:"956",height:"869"})}),"\n",(0,s.jsx)(n.h3,{id:"\u8996\u89ba\u5316\u76e3\u63a7\u7cfb\u7d71\u5c55\u793a",children:"\u8996\u89ba\u5316\u76e3\u63a7\u7cfb\u7d71\u5c55\u793a"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"\u4e0a\u534a\u90e8\u63d0\u4f9b node \u7684\u672c\u8eab\u7684 CPU \u4f7f\u7528\u7387\u3001Memory \u4f7f\u7528\u72c0\u6cc1\u3001\u7db2\u8def\u72c0\u6cc1\u3001\u786c\u789f\u4f7f\u7528\u72c0\u6cc1\u7b49\u7b49\u8cc7\u8a0a\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"grafana-datasource-result-node",src:r(4418).A+"",width:"1920",height:"869"})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsx)(n.li,{children:"\u4e0b\u534a\u90e8\u63d0\u4f9b\u5404\u500b container \u4f7f\u7528\u7684\u72c0\u6cc1\uff0c\u53e6\u5916\u4e5f\u63d0\u4f9b\u8a73\u7d30\u8a0a\u606f\uff0c\u53ef\u4ee5\u5feb\u901f\u627e\u5c0b\u6709\u554f\u984c\u7684 container\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"grafana-datasource-result-container",src:r(64849).A+"",width:"1920",height:"869"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"grafana-datasource-result-container-info",src:r(96128).A+"",width:"1920",height:"869"})})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},10662:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/cAdvisor-d8e42877a8e76540e32e1fe3ccadb3ae.png"},3640:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/grafana-dashboard-import-5535721ea06852fbf5980a71bd7e13fa.png"},33559:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/grafana-dashboard-prometheus-5546e669e56ec1d57baee77ca06a6883.png"},78003:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/grafana-dashboard-sidebar-33d2b59e03d703d9ca58774b9399c677.png"},30721:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/grafana-dashboard-template-ada21c9f7587c725d1c4c05db270432e.png"},47484:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/grafana-dashboard-upload-4dbfbd1d973cd155709cb82e6fc3e2f4.png"},96223:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/grafana-datasource-add-e7359258638f9858c38d9cde5ac287de.png"},28856:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/grafana-datasource-connect-9481f584b0be810eac0df7ffca979a51.png"},96128:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/grafana-datasource-result-container-info-02db7dec70aad0b402207c7f809b3cb3.png"},64849:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/grafana-datasource-result-container-08e58e36d00f94854c2e0bbfa522f326.png"},4418:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/grafana-datasource-result-node-9bf041aa14daef4d72a1fb769c2d4328.png"},36923:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/grafana-datasource-save-ac609d0290169f454796c0044e1ada92.png"},13638:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/grafana-datasource-sidebar-1f5d3488bfb30fb54974fab213b4d375.png"},40015:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/grafana-login-441c0315d3a262afd707971fa91f3c6a.png"},31047:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/prometheus-target-job-596c97c495235d06efd753cee91ba621.png"},28453:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>c});var s=r(96540);const a={},t=s.createContext(a);function i(e){const n=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);